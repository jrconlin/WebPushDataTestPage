<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8" />
    <title>Web Push Data Encryption Test Page</title>
    <link href="style.css" rel="stylesheet" />
    <link href="manifest.json" rel="manifest" />
  </head>
  <body>
  <h1>Web Push Data Encryption Test Page</h1>
    <div id="endpoint">
    <label for="endpoint">Endpoint:</label><input name="endpoint" value="http://example.com/" class="value">
    </div>
    <div id="salt">
    <label for="salt">Salt:</label><input name="salt" class="salt value" value="salt">
    </div>
    <div id="remoteKey">
    <label for="remoteKey">Remote Key:</label><textarea class="value" name="remoteKey" ></textarea>
    </div>
    <div id="data">
    <label for="data">Data:</label><textarea name="data">This is test data.
</textarea>
<!-- `Twas brillig, and the slithy toves
Did gyre and gimble in the wabe:
 All mimsy were the borogoves,
  And the mome raths outgrabe.

 "Beware the Jabberwock, my son!
  The jaws that bite, the claws that catch!
 Beware the Jubjub bird, and shun
  The frumious Bandersnatch!"

 He took his vorpal sword in hand:
  Long time the manxome foe he sought -
 So rested he by the Tumtum tree,
  And stood awhile in thought.

 And, as in uffish thought he stood,
  The Jabberwock, with eyes of flame,
 Came whiffling through the tulgey wood,
  And burbled as it came!

 One, two! One, two! And through and through
  The vorpal blade went snicker-snack!
 He left it dead, and with its head
  He went galumphing back.

 "And, has thou slain the Jabberwock?
  Come to my arms, my beamish boy!
 O frabjous day! Callooh! Callay!'
  He chortled in his joy.

 `Twas brillig, and the slithy toves
  Did gyre and gimble in the wabe;
 All mimsy were the borogoves,
  And the mome raths outgrabe. 
    </textarea>
-->
</div>
<div id="ctrl">
<button id="refresh" >Refresh</button>
</div>
<div class="static">
    <div id="localKeyPri">
        <div class="title">Local Key (private):</div>
        <div class="description">The private portion of the Local Key.</div>
        <div class="value wrap"></textarea>
    </div>
    <div id="localKeyPub">
        <div class="title">Local Key (public):</div>
        <div class="description">Negotiation requires a locally generated
        key pair. This key is temporary, but the public key needs to be
        sent as the <span class="def">Encryption Key</span></div>
        <textarea class="value"></textarea>
    </div>
    <div id="localKeyPubRaw">
        <div class="title">Local Key (public, raw):</div>
        <div class="description">This is the same local public key, only formatted in "raw" form. This is the byte array that is used for deriving
            the <span class="nonce">nonce</span></div>
        <div class="value localKeyPubRaw"></div>
    </div>
    <div id="sharedKey">
        <div class="title">Shared Key:</div>
        <div class="description">AES-GCM key material derived from the local key.</div>
        <div class="value"></div>
    </div>
    <div id="encrypt">
        <div id="gcmB">
            <div class="title">Encryption Key</div>
            <div class="description">HKDF generated Bits derived from the shared key material.</div>
            <div class="value"></div>
        </div>
        <div id="nonce">
            <div class="title">Derived Nonce:</div>
            <div class="description">The "nonce" here is derived from the static
               string, run through the KDF which has been seeded from the
               <span class="salt">salt</span> 
                and the <span class="localKeyPubRaw"> localKey</span>.</div>
            <div class="value nonce"></div>
        </div>
        <div id="iv">
            <div class="title">Initialization Vector:</div>
            <div class="description">The AES-GCM Initialization Vector.
            This is a bit more complex, as it's comprised of a known chunk
            created through the same KDF that created the <span class="nonce">
            nonce</span>, as well the index number of the chunk of data
            we're encoding.</div>
            <div class="value"></div>
        </div>
    </div>
    <!-- div id="output">
        <div class="title">Output:</div>
        <div class="value"></span>
    </div -->
    <div id="curl">
        <div class="title">Curl:</div>
        <div class="description">This is a proxy for your library. Please
        note that the input for this is a binary blob. In this case, I'm 
        attempting to write the data out to a file, then read it in with 
        curl. Transcoding the data to base64 or some other encoding mechanism
        will not work.</div>
        <div class="value wrap"></div>
    </div>
    <div id="out">
    <div id="osalt">
        <div class="title">Salt:</div>
        <div class="description">The salt value sent.</div>
        <div class="value salt wrap"></div></div>
    <div id="odh">
        <div class="title">dh:</div>
        <div class="description">Diffie-Hellman key sent.</div>
        <div class="value wrap"></div>
    </div>
    <div id="odata">
        <div class="title">data:</div>
        <div class="description">This is the raw, encrypted data.</div>
        <!-- div class="value"></div -->
        <div class="ctrl"><button id="saveas">Save Data As...</button></div>
    </div>
</div>
  </body>
  <script src="FileSaver.js"></script>
  <script src="ece.js"></script>
  <script src="base64.js"></script>
  <script src="webpush.js"></script>
  <script>

function register() {
    /* Register the service worker */
    navigator.serviceWorker.register("https://evilonastick.com/push/sw.js")
        .then( function(swReg){
            console.debug("Registering...", swReg);
            swReg.addEventListener('message', function(event) {
                console.debug("swMessage", event);
            });
            swReg.pushManager.subscribe({
                userVisibleOnly:true,
            })
            .then(function(sub) {
                console.info("subscription:", sub);
                if (! sub.endpoint) {
                    console.error("Crap, subscription doesn't have an " +
                                  "endpoint. Aborting.");
                    return;
                }
                output('endpoint', sub.endpoint);
                output('remoteKey', base64url.encode(sub.getKey('p256dh')));
                console.debug ("Auth key: ", 
                                base64url.encode(sub.getKey('auth')));
                output('salt', 
                       base64url.encode(crypto.getRandomValues(
                                            new Uint8Array(16))));
                return sub.endpoint;
            })
            .catch(function(err) {
                console.error("ERROR: ", err);
            });
        })
    .catch(function(err) {
        console.error("Registration Error:", err);
    });
};

var endpoint = register();

function getSubscription() {
    /* Get a WebPush subscription via the service worker.
    */
    return navigator.serviceWorker.ready
        .then(function(reg) {
            sub = reg.pushManager.getSubscription();
            if (sub) {
                return sub;
            }
            else {
                console.error("No subscription found.");
            }
        });
}

function go(remoteKey) {
    /* Fetch & fill various fields, attempt to create a message and send
       it to yourself.
    */
    var endpoint = document.getElementsByName("endpoint")[0].value;
    var salt = document.getElementsByName("salt")[0].value;
    if (!salt) {
        return;
    }
    if (! remoteKey) {
        remoteKey = document.getElementsByName("remoteKey")[0].value;
    }
    var data = document.getElementsByName("data")[0].value;
    var encr = webpush({endpoint: endpoint, 
                        p256dh: base64url.decode(remoteKey)}, 
                        data,
                        base64url.decode(salt))
        .then(d => {
                // Populate the extra fields
                output('osalt', base64url.encode(d.salt));
                output('odh', base64url.encode(d.dh));
                // TODO: neither of these export binary data correctly, 
                //       so curl can process it the same as fetch();
                // TODO: Why isn't this converting to straight binary?
                var blob = new Blob(d.body, 
                    {type: "application/octet-binary"});
                document.getElementById('saveas').onclick = function(){
                    saveAs(blob, "encrypted.data");
                };
                // Construct the curl. Remember, this needs to 
                // write a binary file first, then have curl read that file.
                // This is because putting the data "inline" can fail.
                let outStr = "";
                let sbody = "";
                // TODO: doesn't produce same output as above.
                for (let k in d.body){
                    sbody += "\\x" + (d.body[k]).toString(16);
                }
                outStr += 'echo -e "' + sbody + '" > encrypted.data;\n';
                outStr += "curl -v -X " + d.method + " " + d.endpoint + " ";
                for (let k in d.pheaders) {
                    outStr += " -H \"" + k + ": "+ d.pheaders[k] +"\" "
                }
                outStr += ' --data-binary @encrypted.data';
                output('curl', outStr);
              });
    console.debug(encr);
}

getSubscription()
    .then(function(sub) {
        if (!sub) {
            console.error("Got empty subscription info block");
            throw("EmptySub");
        }
        return sub;
     })
    .then(function(sub) {
        console.debug("Sub:", sub);
        if (true) {
            if (!sub.getKey) {
                console.error("Crap, subscription doesn't have a key. " +
                              "Aborting.");
                return;
            }
            var key = base64url.encode(sub.getKey('p256dh'));
            console.info("Key: ", key);
            return key;
        } else {
            // generate the fakey remote key
            v = webCrypto.generateKey(P256DH, true, ['deriveKey'])
                .then(key =>{
                    console.debug("Saving key...");
                    saveKey('p256dh', key);
                    webCrypto.exportKey('raw', key.publicKey)
                        .then(pkey => {
                            skey = base64url.encode(pkey);
                            console.debug('remoteKey', skey);
                            output('remoteKey', skey);
                            go(skey);
                        })
                        .catch(err => console.error("key save:", err));
            });
            return v;
        }
           
    })
    .then(key => { 
        if (key) {go(key)}
    })
    .catch(function(err) {
        console.error("attempting local decode:", err);
    });

document.getElementById("refresh").onclick = function(event) {
    go(document.getElementsByName("remoteKey")[0].value);
}

document.addEventListener("message", function(e){
    console.log("Main got", e, e.data);
});


  </script>
</html>
